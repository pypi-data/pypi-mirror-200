{"version":3,"sources":["UploadField.js","FileReaderUtils.js","index.tsx"],"names":["i","UploadField","props","state","identification","args","socket_uri","title","upload_suffix","chunk_size","handleFolderUpload","bind","connect","addFile","query","this","num_files","WebSocket","websocket","onopen","evt","console","log","sendFile","files","onclose","onerror","e","msg","event","target","file_list","length","instance_name","webkitRelativePath","split","includes","push","setState","file_names","style","marginBottom","marginRight","width","type","id","webkitdirectory","onChange","hidden","for","cursor","FolderAddOutlined","onClick","marginLeft","UploadOutlined","header","size","bordered","dataSource","renderItem","item","Item","height","overflow","padding","border","StreamlitComponentBase","index","file","send","JSON","stringify","file_name","name","destination","slice","position","onmessage","data","chunk","get_chunk","uploadChunk","Streamlit","setComponentValue","withStreamlitConnection","ReactDOM","render","StrictMode","document","getElementById"],"mappings":"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","file":"static/js/main.03282d56.chunk.js","sourcesContent":["\nimport {\n  Streamlit,\n  StreamlitComponentBase,\n  withStreamlitConnection,\n} from \"streamlit-component-lib\"\nimport React from \"react\"\nimport { UploadOutlined, FolderAddOutlined } from '@ant-design/icons';\nimport { Button, Row, List } from 'antd';\nimport { get_chunk } from \"./FileReaderUtils\";\n\n\n// the `render()` function is called when component is re-rendered\nclass UploadField extends StreamlitComponentBase {\n  constructor(props) {\n    super(props);\n    this.state = {\n      \"files\": null,\n      \"num_files\": 0,\n      \"file_names\": [],\n      \"file_format\": null,\n      \"progress\": 0,\n    };\n    this.identification = props.args[\"identification\"];\n    this.socket_uri = props.args[\"socket_uri\"];\n    this.title = props.args[\"title\"];\n    this.upload_suffix = props.args[\"upload_suffix\"];\n    this.chunk_size = props.args[\"chunk_size\"]\n    this.handleFolderUpload = this.handleFolderUpload.bind(this);\n    this.connect = this.connect.bind(this);\n    this.addFile = this.addFile.bind(this);\n  };  \n\n  connect() {\n    let query = (\n      \"?identification=\"+this.identification\n      +\"&num_files=\"+this.state.num_files\n      +\"&sub_dest=\"+this.upload_suffix\n    );\n    const websocket = new WebSocket(this.socket_uri+query);\n    return websocket\n  };\n\n  async handleFolderUpload() {\n    const websocket = this.connect();\n    websocket.onopen = (evt) => {\n      console.log(\"Socket connection is open\");\n      sendFile(\n        websocket, \n        this.state.files, \n        0, \n        this.chunk_size, \n      );\n    };\n\n    websocket.onclose = function() {\n      console.log(\"Socket connection closed.\");\n    };\n    websocket.onerror = function(e) {\n        console.log(\"Socket connection raised an error.\");\n        console.log(e.msg);\n    };\n  };\n\n  addFile(event) {\n    let files = event.target.files;\n    let file_list = [];\n    for (let i=0; i<files.length; i++){\n      let instance_name = files[i].webkitRelativePath.split(\"/\")[1];\n      if (!file_list.includes(instance_name)){\n        file_list.push(instance_name)\n      };\n    }\n    this.setState({\n      files: files,\n      file_names: file_list,\n      num_files: file_list.length,\n    });\n    console.log(this.state)\n  };\n\n  render() {\n    return (\n      <div>\n        <Row style={{marginBottom: \"10px\"}}>\n          <Button style={{ marginRight: \"10px\", width: \"190px\"}}>\n            <input \n              type=\"file\"\n              id={this.upload_suffix}\n              webkitdirectory=\"true\"\n              onChange={this.addFile}  \n              hidden={true}\n            />\n\n            <label \n              for={this.upload_suffix} \n              style={{cursor:\"pointer\", width: \"100%\"}}\n            > \n              Select Folder <FolderAddOutlined /> \n            </label>\n          </Button>\n          <Button \n            onClick={(event) => {this.handleFolderUpload()}}\n            style={{ marginLeft: \"10px\", width:\"190px\"}}\n          >\n              Start Upload <UploadOutlined />\n          </Button>\n        </Row> \n        <Row>\n        <List \n            header={this.state.title}\n            size=\"small\"\n            bordered\n            dataSource={this.state.file_names}\n            renderItem={(item) => <List.Item>{item}</List.Item>}\n            style={{\n              height: 200,\n              width: \"100%\",\n              overflow: 'auto',\n              padding: '0 16px',\n              border: '1px solid rgba(140, 140, 140, 0.35)',\n            }}\n        />\n        </Row>\n      </div>\n    );\n  }\n}\n\nfunction uploadChunk(websocket, file, position, chunk_size) {\n  let chunk = get_chunk(file, position, chunk_size);\n  websocket.send(chunk);\n  return position + chunk_size;\n};\n\nfunction sendFile(websocket, files, index, chunk_size){\n  console.log(\"Sending file\")\n  if (index>=files.length) {\n    console.log(\"Upload of all files done\")\n  } else {\n    const file = files[index];\n    // HEADER\n    websocket.send(\"HEADER START\");\n    websocket.send(JSON.stringify({\n      file_name: file.name,\n      destination: file.webkitRelativePath.split(\"/\").slice(1),\n    }));\n    websocket.send(\"HEADER END\");\n\n    // FILE\n    let position = 0;\n    websocket.send(\"FILE START\")\n    websocket.onmessage = (evt) => {\n      if (evt.data===\"OK\" & position<file.size) {\n        position = uploadChunk(websocket, file, position, chunk_size);\n        if (position>=file.size){\n          console.log(\"Upload Success\");\n          websocket.send(\"FILE END\");\n        };\n      } else if (evt.data===\"UPLOAD DONE\") {\n        Streamlit.setComponentValue((index+1)/files.length * 100)\n        sendFile(websocket, files, index+1, chunk_size)\n      };\n    };\n  };\n};\n\n// connection between component and Streamlit\nexport default withStreamlitConnection(UploadField)","\nfunction get_chunk(file, position, chunk_size) {\n    let end_position = position+chunk_size;\n    if (end_position<file.size) {\n        return file.slice(position, position+chunk_size);\n    } else {\n        return file.slice(position, file.size);\n    };\n}\n\nexport { get_chunk }","import React from \"react\"\nimport ReactDOM from \"react-dom\"\nimport UploadField from \"./UploadField\"\n\nReactDOM.render(\n  <React.StrictMode>\n    <UploadField />\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n)\n"],"sourceRoot":""}